<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title> Administrador Gym</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: 'Arial', sans-serif; background:#111; color:#f4f4f4; }

  header {
    background: url('https://images.unsplash.com/photo-1517836357463-d25dfeac3438') no-repeat center center/cover;
    height: 90vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: white;
    padding: 20px;
    position: relative;
  }

  header h1 {
    font-size: 3em;
    text-shadow: 2px 2px 6px #000;
  }

  header p {
    font-size: 1.3em;
    margin-top: 10px;
    text-shadow: 1px 1px 4px #000;
  }

  .panel {
    margin-top: 20px; /* Separaci√≥n del texto */
    background: rgba(0,0,0,0.7);
    padding: 30px;
    border-radius: 15px;
    max-width: 600px;
    width: 90%;
    text-align: center;
  }

  nav {
    display: flex;
    justify-content: space-around;
    margin-bottom: 20px;
  }

  nav button {
    padding:10px 20px;
    border:none;
    border-radius:5px;
    background:#2ecc71;
    color:#fff;
    cursor:pointer;
    transition:0.3s;
  }

  nav button:hover { background:#27ae60; }

  section { display:none; margin-top:20px; }

  select,input,textarea,button {
    width:100%;
    padding:10px;
    margin:10px 0;
    border-radius:5px;
    border:none;
  }

  a.button {
    display:inline-block;
    padding:10px 20px;
    background:#25D366;
    color:#fff;
    text-decoration:none;
    border-radius:5px;
  }

</style>
</head>
<body>

<header>
  <h1>üèãÔ∏è‚Äç‚ôÄÔ∏è Panel del Coach Pro</h1>
  <p>üö®Tu gimnasio bajo control! Supervisa pagos, env√≠a recordatorios y ayuda a tus miembros a alcanzar sus metas üí•</p>


  <!-- Panel dentro del header -->
  <div class="panel">
    <nav>
      <button onclick="showSection('alerta')">Alerta Membres√≠a</button>
      <button onclick="showSection('proximos')">Usuarios Pr√≥ximos a Vencer</button>
      <button onclick="showSection('registro')">Registrar Pago</button>
      <button onclick="showSection('nuevoUsuario')">Ingresar Nuevo Usuario</button>
    </nav>

    <!-- Secciones -->
    <section id="alerta">
      <h2>üîî Enviar alerta de membres√≠a</h2>
      <select id="contactos"><option value="">Selecciona un usuario</option></select>
      <a id="btnAlerta" class="button" href="#" target="_blank">üöÄ Enviar Alerta por WhatsApp</a>
    </section>

   
    <section id="nuevoUsuario">
      <h2> ‚ûï Agregar Nuevo Usuario</h2>
      <form id="formNuevoUsuario">
        <input type="text" name="nombre" id="nombreUsuario" placeholder="Nombre" required>
        <input type="email" name="correo" id="correoUsuario" placeholder="Correo" required>
        <input type="text" name="telefono" id="telefonoUsuario" placeholder="Tel√©fono" required>
        <input type="hidden" name="mensaje" value="">
        <button type="submit">Agregar Usuario</button>
      </form>
      <iframe name="hiddenFrame" style="display:none;"></iframe>
    </section>
   
    
    <section id="proximos">
      <h2>‚è∞ Usuarios pr√≥ximos a vencer</h2>
      <ul id="usuariosProximos"></ul>
    </section>

    <section id="registro">
       <h2>Registrar nuevo pago</h2>
       <form id="formPago">
       <input type="date" id="fechaPago" required />
       
       <!-- Selecci√≥n de usuario en lugar de escribir el nombre -->
       <select id="usuariosPago" required>
       <option value="">Selecciona Usuario</option>
       </select>
       
       <input type="number" id="montoPago" placeholder="Monto" required />
       <select id="medioPago" required>
       <option value="">Selecciona Medio de Pago</option>
       <option value="Efectivo">Efectivo</option>
       <option value="Transferencia">Transferencia</option>
       <option value="Tarjeta">Tarjeta</option>
       </select>
       <button type="submit">Registrar Pago</button>
       </form>
    </section>

  </div>
</header>

<script>
function showSection(id){
  document.querySelectorAll('section').forEach(sec=>sec.style.display='none');
  document.getElementById(id).style.display='block';
}

// Creamos un array global para mantener todos los usuarios cargados
let usuarios = [];

// Modificamos cargarUsuarios para guardar los usuarios
function cargarUsuarios(data){
  usuarios = data; // Guardamos globalmente
  const select = document.getElementById("contactos");
  const selectPago = document.getElementById("usuariosPago");
  select.innerHTML = '<option value="">Selecciona un usuario</option>';
  selectPago.innerHTML = '<option value="">Selecciona Usuario</option>';

  data.forEach(u=>{
    // Dropdown alerta
    const option = document.createElement("option");
    option.value = u.NumeroContacto + "|" + encodeURIComponent(u.MensajeAlerta);
    option.textContent = u.NombreCompleto;
    select.appendChild(option);

    // Dropdown pago
    const optionPago = document.createElement("option");
    optionPago.value = u.NombreCompleto;
    optionPago.textContent = u.NombreCompleto;
    selectPago.appendChild(optionPago);
  });
}

// JSONP
const script = document.createElement('script');
script.src = "https://script.google.com/macros/s/AKfycbxny5x1P_HUdiB1kLrJ_rxhSxyPlQKxadfhzCBjAPCqVS-67pPFx29gMPBeHhrT1QE/exec?callback=cargarUsuarios";
document.body.appendChild(script);

// Cambiar enlace WhatsApp
document.getElementById("contactos").addEventListener("change",function(){
  const val=this.value;
  if(!val) return;
  const [numero,mensaje]=val.split("|");
  const btn=document.getElementById("btnAlerta");
  btn.href=`https://api.whatsapp.com/send?phone=57${numero}&text=${decodeURIComponent(mensaje)}`;
});


//ingresar pagos
document.getElementById("formPago").addEventListener("submit", function(e) {
  e.preventDefault();

  const fecha = document.getElementById("fechaPago").value;
  const nombre = document.getElementById("usuariosPago").value;
  const monto  = document.getElementById("montoPago").value;
  const medio  = document.getElementById("medioPago").value;

  console.log("DEBUG >>>", { fecha, nombre, monto, medio });

  const formData = new FormData();
  formData.append("fechaPago", fecha);
  formData.append("nombre", nombre);
  formData.append("monto", monto);
  formData.append("medioPago", medio);

  fetch("https://script.google.com/macros/s/AKfycbxny5x1P_HUdiB1kLrJ_rxhSxyPlQKxadfhzCBjAPCqVS-67pPFx29gMPBeHhrT1QE/exec", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(json => {
    if (json.status === "ok") {
      alert("‚úÖ Pago registrado correctamente");
      document.getElementById("formPago").reset();
    } else {
      alert("‚ùå Error servidor: " + (json.message || "Error desconocido"));
    }
  })
  .catch(err => {
    alert("üö® Error de red: " + err);
  });
});

document.getElementById("formNuevoUsuario").addEventListener("submit", function(e){
  e.preventDefault();

  const nombre = document.getElementById("nombreUsuario").value.trim();
  const correo = document.getElementById("correoUsuario").value.trim();
  const telefono = document.getElementById("telefonoUsuario").value.trim();

  if(!nombre || !correo || !telefono) return;

  // Crear FormData
  const formData = new FormData();
  formData.append("accion", "nuevoUsuario");
  formData.append("nombre", nombre);
  formData.append("correo", correo);
  formData.append("telefono", telefono);
  formData.append("mensaje", ""); // mensaje vac√≠o

  fetch("https://script.google.com/macros/s/AKfycbxny5x1P_HUdiB1kLrJ_rxhSxyPlQKxadfhzCBjAPCqVS-67pPFx29gMPBeHhrT1QE/exec", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(json => {
    if(json.status === "ok") {
      alert("‚úÖ Usuario agregado correctamente");
      document.getElementById("formNuevoUsuario").reset();

      // Agregar al dropdown inmediatamente
      const select = document.getElementById("contactos");
      const selectPago = document.getElementById("usuariosPago");

      const option = document.createElement("option");
      option.value = telefono + "|" + encodeURIComponent(""); // mensaje vac√≠o
      option.textContent = nombre;
      select.appendChild(option);

      const optionPago = document.createElement("option");
      optionPago.value = nombre;
      optionPago.textContent = nombre;
      selectPago.appendChild(optionPago);

    } else {
      alert("‚ùå Error: " + (json.message || "Error desconocido"));
    }
  })
  .catch(err => alert("üö® Error de red: que paso " + err));
});

// Funci√≥n para mostrar usuarios pr√≥ximos a vencer
function mostrarUsuariosProximos() {
  const lista = document.getElementById("usuariosProximos");
  lista.innerHTML = ""; // Limpiar lista

  // Filtrar solo los que tienen MensajeAlerta distinto de "false" y no vac√≠o
  const filtrados = usuarios.filter(u => u.MensajeAlerta && u.MensajeAlerta.toLowerCase() !== "false");

  if(filtrados.length === 0){
    const li = document.createElement("li");
    li.textContent = "No hay usuarios con alerta pendiente.";
    lista.appendChild(li);
    return;
  }

  filtrados.forEach(u=>{
    const li = document.createElement("li");
    li.textContent = `${u.NombreCompleto}`;
    lista.appendChild(li);
  });
}

// Ajustamos el bot√≥n para que adem√°s de mostrar la secci√≥n, llame a mostrarUsuariosProximos
document.querySelector("button[onclick=\"showSection('proximos')\"]")
  .addEventListener("click", function(){
    showSection('proximos');
    mostrarUsuariosProximos();
});
 

</script>

</body>
</html>
